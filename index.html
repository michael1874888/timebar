<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TimeBar - ä½ çš„æ™‚é–“ï¼Œä½ å®šåƒ¹</title>
  <meta name="description" content="æŠŠæ¯ä¸€ç­†æ¶ˆè²»è½‰æ›æˆé€€ä¼‘æ™‚é–“æˆæœ¬ï¼Œè®“ä½ åšå‡ºæ›´æ˜æ™ºçš„è²¡å‹™æ±ºç­–">
  <meta name="theme-color" content="#111827">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>â±ï¸</text></svg>">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'Noto Sans TC', 'system-ui', 'sans-serif'],
          },
        },
      },
    }
  </script>
  
  <style>
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { font-family: 'Inter', 'Noto Sans TC', system-ui, sans-serif; background: #111827; margin: 0; padding: 0; min-height: 100vh; overflow-x: hidden; }
    
    .slider { -webkit-appearance: none; appearance: none; height: 8px; border-radius: 9999px; background: linear-gradient(to right, #374151, #4b5563); outline: none; }
    .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); cursor: pointer; box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); transition: transform 0.15s ease; }
    .slider::-webkit-slider-thumb:hover { transform: scale(1.1); }
    .slider::-webkit-slider-thumb:active { transform: scale(0.95); }
    .slider::-moz-range-thumb { width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); cursor: pointer; border: none; box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); }
    .slider.orange::-webkit-slider-thumb { background: linear-gradient(135deg, #f97316, #ea580c); box-shadow: 0 0 20px rgba(249, 115, 22, 0.4); }
    .slider.orange::-moz-range-thumb { background: linear-gradient(135deg, #f97316, #ea580c); box-shadow: 0 0 20px rgba(249, 115, 22, 0.4); }
    
    @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes confetti { 0% { transform: translateY(-10px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
    
    .animate-fade-in { animation: fade-in 0.4s ease-out; }
    .animate-slide-up { animation: slide-up 0.5s ease-out; }
    .animate-confetti { animation: confetti 2s ease-out forwards; }
    .tabular-nums { font-variant-numeric: tabular-nums; }
    
    .spinner { width: 40px; height: 40px; border: 3px solid #374151; border-top-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;

    // ==================== CONFIG ====================
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzZi4pEbKa_bEKtyKppVw9Ls_jmx8QdgP6zlarNiWI4ylXWJb5qpvcC-a9flq5Jvxnm/exec'; // ä¾‹å¦‚: 'https://script.google.com/macros/s/xxx/exec'
    
    // ==================== CONSTANTS ====================
    const DEFAULT_INFLATION_RATE = 2.5;
    const DEFAULT_ROI_RATE = 6;
    const WORKING_DAYS_PER_MONTH = 22;
    const WORKING_HOURS_PER_DAY = 8;

    // ==================== FINANCIAL CALCULATIONS ====================
    const FinanceCalc = {
      // è¨ˆç®—å¯¦è³ªå ±é…¬ç‡
      realRate(inflation, roi) {
        return (1 + roi / 100) / (1 + inflation / 100) - 1;
      },
      
      // è¨ˆç®—è¤‡åˆ©çµ‚å€¼ (Future Value)
      futureValue(pv, rate, years) {
        return pv * Math.pow(1 + rate, years);
      },
      
      // è¨ˆç®—å¹´é‡‘çµ‚å€¼ (æ¯æœˆæŠ•å…¥)
      annuityFV(monthly, rate, years) {
        const monthlyRate = rate / 12;
        const months = years * 12;
        if (monthlyRate === 0) return monthly * months;
        return monthly * ((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate);
      },
      
      // è¨ˆç®—é”æˆç›®æ¨™é‡‘é¡éœ€è¦å¹¾å¹´
      yearsToTarget(currentSavings, monthlySavings, targetAmount, rate) {
        if (currentSavings >= targetAmount) return 0;
        
        const monthlyRate = rate / 12;
        
        // Binary search for years
        let low = 0, high = 100;
        while (high - low > 0.01) {
          const mid = (low + high) / 2;
          const fv = this.futureValue(currentSavings, rate, mid) + this.annuityFV(monthlySavings, rate, mid);
          if (fv < targetAmount) {
            low = mid;
          } else {
            high = mid;
          }
        }
        return (low + high) / 2;
      },
      
      // è¨ˆç®—ç›®æ¨™é€€ä¼‘é‡‘ï¼ˆåŸºæ–¼ç›®æ¨™é€€ä¼‘å¹´é½¡ï¼‰
      targetFundByAge(currentSavings, monthlySavings, yearsToRetire, rate) {
        return this.futureValue(currentSavings, rate, yearsToRetire) + 
               this.annuityFV(monthlySavings, rate, yearsToRetire);
      },
      
      // 4% æ³•å‰‡ï¼šæœˆé ˜é‡‘é¡ â†’ éœ€è¦å¤šå°‘é€€ä¼‘é‡‘
      monthlyToFund(monthlyExpense) {
        return monthlyExpense * 300;
      },
      
      // 4% æ³•å‰‡ï¼šé€€ä¼‘é‡‘ â†’ å¯ä»¥æœˆé ˜å¤šå°‘
      fundToMonthly(fund) {
        return fund / 300;
      },
      
      // è¨ˆç®—æ¯æœˆéœ€å„²è“„å¤šå°‘æ‰èƒ½é”æˆç›®æ¨™
      requiredMonthlySavings(currentSavings, targetAmount, years, rate) {
        const monthlyRate = rate / 12;
        const months = years * 12;
        const fvCurrent = this.futureValue(currentSavings, rate, years);
        const remaining = targetAmount - fvCurrent;
        
        if (remaining <= 0) return 0;
        if (monthlyRate === 0) return remaining / months;
        
        return remaining / ((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate);
      },
      
      // è¨ˆç®—é ä¼°é€€ä¼‘å¹´é½¡ (ETA)
      estimatedRetireAge(userData, netSavingsImpact = 0) {
        const { age, currentSavings, monthlySavings, retireAge, inflationRate, roiRate } = userData;
        const realRate = this.realRate(inflationRate, roiRate);
        
        // ç›®æ¨™é€€ä¼‘é‡‘ = æŒ‰åŸè¨ˆç•«èƒ½å­˜åˆ°çš„é‡‘é¡
        const yearsToRetire = retireAge - age;
        const targetFund = this.targetFundByAge(currentSavings, monthlySavings, yearsToRetire, realRate);
        
        // è€ƒæ…®å¯¦éš›è¡Œç‚ºå¾Œçš„èª¿æ•´
        const adjustedSavings = currentSavings + netSavingsImpact;
        
        // è¨ˆç®—éœ€è¦å¹¾å¹´æ‰èƒ½é”åˆ°ç›®æ¨™
        const yearsNeeded = this.yearsToTarget(adjustedSavings, monthlySavings, targetFund, realRate);
        
        return age + yearsNeeded;
      }
    };

    // ==================== UTILITIES ====================
    const formatTime = (totalHours) => {
      const absHours = Math.abs(totalHours);
      if (absHours < 1) return { value: Math.round(absHours * 60), unit: 'åˆ†é˜', color: 'text-emerald-400' };
      if (absHours < 8) return { value: Math.round(absHours * 10) / 10, unit: 'å°æ™‚', color: 'text-emerald-400' };
      if (absHours < 24) return { value: Math.round(absHours * 10) / 10, unit: 'å°æ™‚', color: 'text-yellow-400' };
      if (absHours < 24 * 7) return { value: Math.round(absHours / 24 * 10) / 10, unit: 'å¤©', color: 'text-yellow-400' };
      if (absHours < 24 * 30) return { value: Math.round(absHours / 24 * 10) / 10, unit: 'å¤©', color: 'text-orange-400' };
      if (absHours < 24 * 365) return { value: Math.round(absHours / 24 / 30 * 10) / 10, unit: 'å€‹æœˆ', color: 'text-orange-500' };
      return { value: Math.round(absHours / 24 / 365 * 100) / 100, unit: 'å¹´', color: 'text-red-500' };
    };

    const formatCurrency = (amount) => {
      if (Math.abs(amount) >= 100000000) return `${(amount / 100000000).toFixed(2)}å„„`;
      if (Math.abs(amount) >= 10000) return `${(amount / 10000).toFixed(amount % 10000 === 0 ? 0 : 1)}è¬`;
      return amount.toLocaleString();
    };

    const formatCurrencyFull = (amount) => `NT$ ${amount.toLocaleString()}`;

    const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];

    const getEquivalent = (hours, isSpend) => {
      const absHours = Math.abs(hours);
      const items = isSpend ? [
        { max: 2, texts: ['ä¸€æ¯å’–å•¡çš„æ™‚é–“', 'ä¸€é “åˆé¤'] },
        { max: 8, texts: ['ä¸€å¤©çš„å·¥ä½œ', 'ä¸€æ¬¡é›»å½±ç´„æœƒ'] },
        { max: 24, texts: ['ä¸€æ•´å¤©çš„ä¼‘æ¯', 'ä¸€é “é«˜ç´šé¤å»³'] },
        { max: 168, texts: ['ä¸€é€±çš„å‡æœŸ', 'ä¸€è¶Ÿåœ‹å…§æ—…è¡Œ'] },
        { max: 720, texts: ['ä¸€å€‹æœˆçš„è‡ªç”±', 'ä¸€è¶Ÿæ—¥æœ¬æ—…è¡Œ'] },
        { max: 8760, texts: ['ä¸€æ•´å¹´çš„æ™‚å…‰', 'ç’°éŠä¸–ç•Œçš„æ©Ÿæœƒ'] },
        { max: Infinity, texts: ['å¥½å¹¾å¹´çš„é€€ä¼‘ç”Ÿæ´»', 'è²¡å‹™è‡ªç”±çš„é—œéµ'] },
      ] : [
        { max: 8, texts: ['å¤šç¡ä¸€å¤©æ‡¶è¦º', 'é€€ä¼‘å¾Œçš„æ‚ é–’æ—©æ™¨'] },
        { max: 24, texts: ['å¤šä¸€å¤©å»çˆ¬å±±', 'é™ªå®¶äººçš„ä¸€å¤©'] },
        { max: 168, texts: ['å¤šä¸€é€±çš„æ—…è¡Œ', 'å­¸ä¸€é …æ–°æŠ€èƒ½'] },
        { max: 720, texts: ['å¤šä¸€å€‹æœˆçš„è‡ªç”±', 'å®Œæˆä¸€å€‹å°å¤¢æƒ³'] },
        { max: Infinity, texts: ['äººç”Ÿå¤šäº†å¥½å¤šå¯èƒ½', 'é›¢è²¡å‹™è‡ªç”±æ›´è¿‘ä¸€æ­¥'] },
      ];
      return getRandomItem((items.find(i => absHours <= i.max) || items[items.length - 1]).texts);
    };

    const getMotivationalQuote = () => getRandomItem([
      'æ¯ä¸€åˆ†éŒ¢éƒ½æ˜¯ä½ æœªä¾†è‡ªç”±çš„ç£šå¡Š ğŸ§±',
      'ä»Šå¤©çš„å¿è€ï¼Œæ˜¯æ˜å¤©çš„è‡ªç”± âœ¨',
      'å°‘è²·ä¸€å€‹ï¼Œå¤šæ´»ä¸€å¤© ğŸ’ª',
      'è‡ªç”±ä¸æ˜¯å…è²»çš„ï¼Œæ˜¯çœå‡ºä¾†çš„ ğŸ¯',
      'ä½ æ­£åœ¨è²·å›è‡ªå·±çš„æ™‚é–“ â°',
      'é€€ä¼‘å¾Œçš„ä½ æœƒæ„Ÿè¬ç¾åœ¨çš„æ±ºå®š ğŸ™',
    ]);

    // ==================== API ====================
    const GoogleSheetsAPI = {
      isConfigured: () => !!GAS_WEB_APP_URL,
      
      async saveRecord(record) {
        if (!this.isConfigured()) return { success: false };
        try {
          await fetch(GAS_WEB_APP_URL, {
            method: 'POST', mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'addRecord', data: record }),
          });
          return { success: true };
        } catch (e) { return { success: false }; }
      },
      
      async saveUserData(userData) {
        if (!this.isConfigured()) return { success: false };
        try {
          await fetch(GAS_WEB_APP_URL, {
            method: 'POST', mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'saveUserData', data: userData }),
          });
          return { success: true };
        } catch (e) { return { success: false }; }
      },
      
      async clearAllData() {
        if (!this.isConfigured()) return { success: false };
        try {
          await fetch(GAS_WEB_APP_URL, {
            method: 'POST', mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'clearAllData' }),
          });
          return { success: true };
        } catch (e) { return { success: false }; }
      },
    };

    const Storage = {
      save(key, data) { try { localStorage.setItem(`timebar_${key}`, JSON.stringify(data)); return true; } catch { return false; } },
      load(key, def = null) { try { const d = localStorage.getItem(`timebar_${key}`); return d ? JSON.parse(d) : def; } catch { return def; } },
      clear() { Object.keys(localStorage).filter(k => k.startsWith('timebar_')).forEach(k => localStorage.removeItem(k)); },
    };

    // ==================== COMPONENTS ====================
    const Confetti = ({ active }) => {
      if (!active) return null;
      const particles = Array.from({ length: 50 }, (_, i) => ({
        id: i, x: Math.random() * 100, delay: Math.random() * 0.5, duration: 1 + Math.random(),
        color: ['#10b981', '#34d399', '#6ee7b7', '#fbbf24', '#f472b6'][Math.floor(Math.random() * 5)],
        size: 8 + Math.random() * 8,
      }));
      return (
        <div className="fixed inset-0 pointer-events-none overflow-hidden z-50">
          {particles.map(p => (
            <div key={p.id} className="absolute rounded-full animate-confetti"
              style={{ left: `${p.x}%`, width: p.size, height: p.size, backgroundColor: p.color,
                animationDelay: `${p.delay}s`, animationDuration: `${p.duration}s` }} />
          ))}
        </div>
      );
    };

    // ==================== ONBOARDING (5 Steps) ====================
    const OnboardingScreen = ({ onComplete }) => {
      const [step, setStep] = useState(0);
      const [age, setAge] = useState(30);
      const [salary, setSalary] = useState(50000);
      const [retireAge, setRetireAge] = useState(65);
      const [currentSavings, setCurrentSavings] = useState(0);
      const [monthlySavings, setMonthlySavings] = useState(10000);
      const [isAnimating, setIsAnimating] = useState(false);

      useEffect(() => {
        setMonthlySavings(Math.round(salary * 0.2));
      }, [salary]);

      const hourlyRate = Math.round(salary / WORKING_DAYS_PER_MONTH / WORKING_HOURS_PER_DAY);
      const realRate = FinanceCalc.realRate(DEFAULT_INFLATION_RATE, DEFAULT_ROI_RATE);
      const yearsToRetire = retireAge - age;
      const projectedFund = FinanceCalc.targetFundByAge(currentSavings, monthlySavings, yearsToRetire, realRate);
      const monthlyRetirement = FinanceCalc.fundToMonthly(projectedFund);

      const handleNext = () => {
        setIsAnimating(true);
        setTimeout(() => {
          if (step < 4) {
            setStep(step + 1);
          } else {
            onComplete({
              age, salary, retireAge, currentSavings, monthlySavings,
              targetRetirementFund: Math.round(projectedFund),
              inflationRate: DEFAULT_INFLATION_RATE,
              roiRate: DEFAULT_ROI_RATE,
            });
          }
          setIsAnimating(false);
        }, 300);
      };

      const steps = [
        {
          title: 'ä½ å¹¾æ­²ï¼Ÿ',
          subtitle: 'è®“æˆ‘å€‘å¾ç¾åœ¨é–‹å§‹è¨ˆç®—',
          content: (
            <div className="flex flex-col items-center">
              <div className="text-8xl font-black text-white mb-4 tabular-nums">{age}</div>
              <div className="text-gray-400 mb-8">æ­²</div>
              <input type="range" min="18" max="55" value={age}
                onChange={(e) => setAge(parseInt(e.target.value))} className="slider w-72" />
              <div className="flex justify-between w-72 text-gray-500 text-sm mt-2">
                <span>18</span><span>55</span>
              </div>
            </div>
          ),
        },
        {
          title: 'æœˆè–ªå¤šå°‘ï¼Ÿ',
          subtitle: 'é€™æ±ºå®šäº†ä½ çš„æ™‚é–“å–®åƒ¹',
          content: (
            <div className="flex flex-col items-center">
              <div className="text-5xl font-black text-white mb-2 tabular-nums">{formatCurrencyFull(salary)}</div>
              <div className="text-gray-400 mb-4">/æœˆ</div>
              <div className="bg-gray-800/50 rounded-2xl px-6 py-3 mb-8">
                <span className="text-gray-400">æ™‚è–ªç´„ </span>
                <span className="text-emerald-400 font-bold">${hourlyRate}</span>
              </div>
              <input type="range" min="25000" max="500000" step="5000" value={salary}
                onChange={(e) => setSalary(parseInt(e.target.value))} className="slider w-72" />
              <div className="flex justify-between w-72 text-gray-500 text-sm mt-2">
                <span>$2.5è¬</span><span>$50è¬</span>
              </div>
            </div>
          ),
        },
        {
          title: 'æƒ³å¹¾æ­²é€€ä¼‘ï¼Ÿ',
          subtitle: 'é€™æ˜¯ä½ çš„ç›®æ¨™ï¼ŒGPS æœƒå¹«ä½ å°èˆª',
          content: (
            <div className="flex flex-col items-center">
              <div className="text-8xl font-black text-white mb-2 tabular-nums">{retireAge}</div>
              <div className="text-gray-400 mb-4">æ­²é€€ä¼‘</div>
              <div className="bg-emerald-500/20 rounded-2xl px-6 py-3 mb-8">
                <span className="text-emerald-400">é‚„æœ‰ </span>
                <span className="text-emerald-300 font-bold">{yearsToRetire} å¹´</span>
                <span className="text-emerald-400"> å¯ä»¥å¥®é¬¥</span>
              </div>
              <input type="range" min={age + 5} max="75" value={retireAge}
                onChange={(e) => setRetireAge(parseInt(e.target.value))} className="slider w-72" />
              <div className="flex justify-between w-72 text-gray-500 text-sm mt-2">
                <span>{age + 5}</span><span>75</span>
              </div>
            </div>
          ),
        },
        {
          title: 'ç›®å‰æœ‰å¤šå°‘å­˜æ¬¾ï¼Ÿ',
          subtitle: 'é€™æ˜¯ä½ çš„èµ·è·‘é»',
          content: (
            <div className="flex flex-col items-center">
              <div className="text-4xl font-black text-white mb-4 tabular-nums">{formatCurrencyFull(currentSavings)}</div>
              <input type="range" min="0" max="10000000" step="100000" value={currentSavings}
                onChange={(e) => setCurrentSavings(parseInt(e.target.value))} className="slider w-72" />
              <div className="flex justify-between w-72 text-gray-500 text-sm mt-2">
                <span>$0</span><span>$1000è¬</span>
              </div>
              <div className="text-gray-500 text-sm mt-4">æ²’æœ‰ä¹Ÿæ²’é—œä¿‚ï¼Œå¾é›¶é–‹å§‹æ›´å²å®³ ğŸ’ª</div>
            </div>
          ),
        },
        {
          title: 'æ¯æœˆå­˜å¤šå°‘ï¼Ÿ',
          subtitle: 'é€™åªæ˜¯ä¼°è¨ˆï¼Œä¹‹å¾Œå¯ä»¥èª¿æ•´',
          content: (
            <div className="flex flex-col items-center">
              <div className="text-4xl font-black text-white mb-2 tabular-nums">{formatCurrencyFull(monthlySavings)}</div>
              <div className="text-gray-400 mb-4">/æ¯æœˆ</div>
              <div className="text-gray-500 text-xs mb-6">ä½”æœˆè–ª {Math.round(monthlySavings / salary * 100)}%</div>
              <input type="range" min="0" max={Math.min(salary, 200000)} step="1000" value={monthlySavings}
                onChange={(e) => setMonthlySavings(parseInt(e.target.value))} className="slider w-72" />
              <div className="flex justify-between w-72 text-gray-500 text-sm mt-2">
                <span>$0</span><span>{formatCurrency(Math.min(salary, 200000))}</span>
              </div>
              
              {/* Preview */}
              <div className="bg-gray-800/60 rounded-2xl p-4 mt-8 w-72 border border-gray-700/50">
                <div className="text-gray-400 text-xs mb-2 text-center">æŒ‰æ­¤è¨ˆç•«ï¼Œ{retireAge}æ­²æ™‚å¯ç´¯ç©</div>
                <div className="text-emerald-400 text-2xl font-bold text-center">{formatCurrency(Math.round(projectedFund))}</div>
                <div className="text-gray-500 text-xs text-center mt-1">
                  é€€ä¼‘å¾Œæ¯æœˆå¯é ˜ç´„ {formatCurrency(Math.round(monthlyRetirement))}
                </div>
              </div>
            </div>
          ),
        },
      ];

      return (
        <div className="min-h-screen bg-gradient-to-b from-gray-900 via-gray-900 to-gray-800 flex flex-col items-center justify-center p-6">
          <div className="mb-8">
            <div className="text-3xl font-black text-white tracking-tight">
              Time<span className="text-emerald-400">Bar</span>
            </div>
            <div className="text-gray-500 text-xs text-center">ä½ çš„æ™‚é–“ï¼Œä½ å®šåƒ¹</div>
          </div>

          <div className="flex gap-2 mb-12">
            {steps.map((_, i) => (
              <div key={i} className={`h-1.5 rounded-full transition-all duration-500 ${
                i === step ? 'w-8 bg-emerald-400' : i < step ? 'w-4 bg-emerald-600' : 'w-4 bg-gray-700'
              }`} />
            ))}
          </div>

          <div className={`text-center mb-8 transition-all duration-300 ${isAnimating ? 'opacity-0 translate-y-4' : 'opacity-100'}`}>
            <h1 className="text-3xl font-bold text-white mb-2">{steps[step].title}</h1>
            <p className="text-gray-400">{steps[step].subtitle}</p>
          </div>

          <div className={`mb-8 transition-all duration-300 ${isAnimating ? 'opacity-0 scale-95' : 'opacity-100'}`}>
            {steps[step].content}
          </div>

          <button onClick={handleNext}
            className="bg-emerald-500 hover:bg-emerald-400 text-gray-900 font-bold py-4 px-16 rounded-2xl text-lg transition-all duration-300 hover:scale-105 active:scale-95 shadow-lg shadow-emerald-500/25">
            {step < 4 ? 'ç¹¼çºŒ' : 'é–‹å§‹ä½¿ç”¨'}
          </button>
        </div>
      );
    };

    // ==================== MAIN TRACKER ====================
    const MainTracker = ({ userData, records, onAddRecord, onOpenHistory, onOpenSettings }) => {
      const [mode, setMode] = useState('spend');
      const [amount, setAmount] = useState(500);
      const [isRecurring, setIsRecurring] = useState(false);
      const [category, setCategory] = useState('');
      const [note, setNote] = useState('');
      const [showResult, setShowResult] = useState(false);
      const [resultType, setResultType] = useState(null);
      const [showConfetti, setShowConfetti] = useState(false);
      const [isSaving, setIsSaving] = useState(false);

      const { age, salary, retireAge, currentSavings, monthlySavings,
              inflationRate = DEFAULT_INFLATION_RATE, roiRate = DEFAULT_ROI_RATE } = userData;
      
      const yearsToRetire = retireAge - age;
      const hourlyRate = salary / WORKING_DAYS_PER_MONTH / WORKING_HOURS_PER_DAY;
      const realRate = FinanceCalc.realRate(inflationRate, roiRate);
      const monthlyRate = realRate / 12;
      const monthsToRetire = yearsToRetire * 12;

      // è¨ˆç®—ç´¯ç©å½±éŸ¿
      const totalSaved = records.filter(r => r.type === 'save').reduce((s, r) => s + r.amount, 0);
      const totalSpent = records.filter(r => r.type === 'spend').reduce((s, r) => s + r.amount, 0);
      const netSavingsImpact = totalSaved - totalSpent;

      // GPS: è¨ˆç®—é ä¼°é€€ä¼‘å¹´é½¡
      const estimatedAge = useMemo(() => {
        return FinanceCalc.estimatedRetireAge(userData, netSavingsImpact);
      }, [userData, netSavingsImpact]);

      const ageDiff = retireAge - estimatedAge;
      const ageDiffDays = Math.round(ageDiff * 365);
      const isAhead = ageDiff > 0.001; // å°æ–¼ç´„åŠå¤©è¦–ç‚ºæŒå¹³
      const isBehind = ageDiff < -0.001;
      const isOnTrack = !isAhead && !isBehind;

      // æ ¼å¼åŒ–å·®ç•°é¡¯ç¤º
      const formatAgeDiff = (diff) => {
        const absDiff = Math.abs(diff);
        const absDays = Math.round(absDiff * 365);
        if (absDays < 1) return { value: '0', unit: 'å¤©', isSmall: true };
        if (absDays < 30) return { value: absDays.toString(), unit: 'å¤©', isSmall: true };
        if (absDays < 365) return { value: Math.round(absDays / 30).toString(), unit: 'å€‹æœˆ', isSmall: false };
        return { value: absDiff.toFixed(1), unit: 'å¹´', isSmall: false };
      };
      const diffDisplay = formatAgeDiff(ageDiff);

      // è¨ˆç®—ç›®æ¨™é€€ä¼‘é‡‘
      const targetFund = FinanceCalc.targetFundByAge(currentSavings, monthlySavings, yearsToRetire, realRate);

      // è¨ˆç®—ç•¶å‰èŠ±è²»/å„²è“„çš„æ™‚é–“æˆæœ¬
      const calculateTimeCost = useCallback(() => {
        let futureValue;
        if (isRecurring) {
          futureValue = amount * ((Math.pow(1 + monthlyRate, monthsToRetire) - 1) / monthlyRate);
        } else {
          futureValue = amount * Math.pow(1 + realRate, yearsToRetire);
        }
        return futureValue / hourlyRate;
      }, [amount, isRecurring, monthsToRetire, yearsToRetire, hourlyRate, monthlyRate, realRate]);

      const timeCost = calculateTimeCost();
      const timeFormatted = formatTime(timeCost);

      const handleSubmit = async () => {
        if (amount <= 0) return;
        setIsSaving(true);
        
        const record = {
          id: Date.now().toString(),
          type: mode,
          amount,
          isRecurring,
          timeCost,
          category: category || (mode === 'spend' ? 'ä¸€èˆ¬æ¶ˆè²»' : 'å„²è“„'),
          note,
          timestamp: new Date().toISOString(),
        };

        await onAddRecord(record);
        setResultType(mode);
        setShowResult(true);
        
        if (mode === 'save') {
          setShowConfetti(true);
          setTimeout(() => setShowConfetti(false), 2000);
        }
        
        setIsSaving(false);
        setTimeout(() => {
          setShowResult(false);
          setResultType(null);
          setAmount(500);
          setCategory('');
          setNote('');
        }, 2500);
      };

      const spendCategories = ['é£²é£Ÿ', 'è³¼ç‰©', 'å¨›æ¨‚', 'äº¤é€š', 'è¨‚é–±', 'å…¶ä»–'];
      const saveCategories = ['è–ªè³‡å„²è“„', 'çé‡‘', 'æŠ•è³‡æ”¶ç›Š', 'å‰¯æ¥­æ”¶å…¥', 'å…¶ä»–'];

      return (
        <div className={`min-h-screen transition-colors duration-700 ${
          resultType === 'spend' ? 'bg-gradient-to-b from-red-950 via-red-900/30 to-gray-900' :
          resultType === 'save' ? 'bg-gradient-to-b from-emerald-950 via-emerald-900/30 to-gray-900' :
          'bg-gradient-to-b from-gray-900 via-gray-900 to-gray-800'
        }`}>
          <Confetti active={showConfetti} />
          
          {/* GPS Header */}
          <div className="pt-4 pb-2 px-4">
            <div className="max-w-lg mx-auto">
              <div className="flex justify-between items-start mb-2">
                <button onClick={onOpenHistory} className="text-left">
                  <div className="text-xs text-gray-500">ğŸ¯ ç›®æ¨™</div>
                  <div className="text-white font-bold text-xl">{retireAge} æ­²</div>
                </button>
                <div className="text-center">
                  <div className="text-xl font-black text-white">
                    Time<span className="text-emerald-400">Bar</span>
                  </div>
                </div>
                <button onClick={onOpenSettings} className="text-right">
                  <div className="text-xs text-gray-500">ğŸ“ é ä¼°</div>
                  <div className={`font-bold text-xl ${isOnTrack ? 'text-white' : isAhead ? 'text-emerald-400' : 'text-orange-400'}`}>
                    {estimatedAge.toFixed(1)} æ­²
                  </div>
                </button>
              </div>
              
              {/* GPS Status Bar */}
              <div className={`rounded-xl px-4 py-2 text-center text-sm ${
                isOnTrack ? 'bg-gray-700 text-gray-300' :
                isAhead ? 'bg-emerald-500/20 text-emerald-400' : 'bg-orange-500/20 text-orange-400'
              }`}>
                {isOnTrack 
                  ? `âœ… å®Œç¾ï¼ç›®å‰å‰›å¥½ç¬¦åˆè¨ˆç•«`
                  : isAhead 
                    ? `ğŸš€ é ˜å…ˆ ${diffDisplay.value} ${diffDisplay.unit}ï¼ç¹¼çºŒä¿æŒï¼`
                    : `â° è½å¾Œ ${diffDisplay.value} ${diffDisplay.unit}ï¼ŒåŠ æ²¹è¿½ä¸Šï¼`
                }
              </div>
            </div>
          </div>

          {/* Stats Summary */}
          <div className="px-4 py-3">
            <div className="max-w-lg mx-auto bg-gray-800/40 rounded-2xl p-4">
              <div className="grid grid-cols-3 gap-4 text-center">
                <div>
                  <div className="text-emerald-400 font-bold text-lg">{formatCurrency(totalSaved)}</div>
                  <div className="text-gray-500 text-xs">é¡å¤–å„²è“„</div>
                </div>
                <div>
                  <div className={`font-bold text-lg ${
                    isOnTrack ? 'text-white' : isAhead ? 'text-emerald-400' : 'text-orange-400'
                  }`}>
                    {isOnTrack ? 'Â±0' : isAhead ? '+' : ''}{ageDiffDays} å¤©
                  </div>
                  <div className="text-gray-500 text-xs">é€€ä¼‘æ™‚é–“å½±éŸ¿</div>
                </div>
                <div>
                  <div className="text-orange-400 font-bold text-lg">{formatCurrency(totalSpent)}</div>
                  <div className="text-gray-500 text-xs">é¡å¤–æ”¯å‡º</div>
                </div>
              </div>
            </div>
          </div>

          {/* Main Content */}
          <div className="px-4 pb-24">
            <div className="max-w-lg mx-auto">
              
              {/* Mode Toggle */}
              <div className="flex justify-center mb-6">
                <div className="bg-gray-800 rounded-2xl p-1.5 flex">
                  <button onClick={() => { setMode('spend'); setShowResult(false); }}
                    className={`px-8 py-3 rounded-xl text-sm font-semibold transition-all duration-300 ${
                      mode === 'spend' ? 'bg-orange-500 text-gray-900 shadow-lg shadow-orange-500/25' : 'text-gray-400 hover:text-white'
                    }`}>ğŸ’¸ èŠ±è²»</button>
                  <button onClick={() => { setMode('save'); setShowResult(false); }}
                    className={`px-8 py-3 rounded-xl text-sm font-semibold transition-all duration-300 ${
                      mode === 'save' ? 'bg-emerald-500 text-gray-900 shadow-lg shadow-emerald-500/25' : 'text-gray-400 hover:text-white'
                    }`}>ğŸ’° å„²è“„</button>
                </div>
              </div>

              {!showResult ? (
                <>
                  {/* Recurring Toggle */}
                  <div className="flex justify-center mb-6">
                    <button onClick={() => setIsRecurring(!isRecurring)}
                      className={`px-4 py-2 rounded-xl text-sm transition-all duration-300 ${
                        isRecurring ? 'bg-purple-500/20 text-purple-400 border border-purple-500/50' : 'bg-gray-800 text-gray-400'
                      }`}>{isRecurring ? 'ğŸ”„ æ¯æœˆå›ºå®š' : 'â˜ï¸ åƒ…æ­¤ä¸€æ¬¡'}</button>
                  </div>

                  {/* Amount Input */}
                  <div className="text-center mb-4">
                    <div className="text-gray-400 text-sm mb-2">{mode === 'spend' ? 'é€™æ¬¡è¦èŠ±' : 'é€™æ¬¡è¦å­˜'}</div>
                    <div className="text-6xl font-black text-white tabular-nums mb-2">{formatCurrencyFull(amount)}</div>
                    {isRecurring && <div className="text-purple-400 text-sm">/æ¯æœˆ</div>}
                  </div>

                  {/* Slider */}
                  <div className="mb-4 px-2">
                    <input type="range" min="0" max="100000"
                      step={amount < 1000 ? 100 : amount < 10000 ? 500 : 1000}
                      value={amount} onChange={(e) => setAmount(parseInt(e.target.value))}
                      className={`slider w-full ${mode === 'spend' ? 'orange' : ''}`} />
                    <div className="flex justify-between text-gray-600 text-xs mt-1">
                      <span>$0</span><span>$10è¬</span>
                    </div>
                  </div>

                  {/* Quick Amounts */}
                  <div className="flex gap-2 justify-center flex-wrap mb-6">
                    {[100, 500, 1000, 3000, 5000, 10000].map((qa) => (
                      <button key={qa} onClick={() => setAmount(qa)}
                        className={`px-3 py-1.5 rounded-lg text-sm transition-all ${
                          amount === qa
                            ? mode === 'spend' ? 'bg-orange-500 text-gray-900' : 'bg-emerald-500 text-gray-900'
                            : 'bg-gray-800 text-gray-400 hover:bg-gray-700'
                        }`}>{formatCurrency(qa)}</button>
                    ))}
                  </div>

                  {/* Category Selection */}
                  <div className="mb-4">
                    <div className="text-gray-400 text-sm mb-2 text-center">åˆ†é¡ï¼ˆé¸å¡«ï¼‰</div>
                    <div className="flex gap-2 justify-center flex-wrap">
                      {(mode === 'spend' ? spendCategories : saveCategories).map((cat) => (
                        <button key={cat} onClick={() => setCategory(category === cat ? '' : cat)}
                          className={`px-3 py-1.5 rounded-lg text-sm transition-all ${
                            category === cat ? 'bg-gray-600 text-white' : 'bg-gray-800/50 text-gray-500 hover:text-gray-300'
                          }`}>{cat}</button>
                      ))}
                    </div>
                  </div>

                  {/* Note Input */}
                  <div className="mb-6">
                    <input type="text" placeholder="å‚™è¨»ï¼ˆé¸å¡«ï¼‰" value={note}
                      onChange={(e) => setNote(e.target.value)}
                      className="w-full bg-gray-800/50 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-gray-600" />
                  </div>

                  {/* Impact Preview */}
                  {amount > 0 && (
                    <div className="bg-gray-800/60 backdrop-blur-sm rounded-3xl p-6 mb-6 border border-gray-700/50 animate-fade-in">
                      <div className="text-center">
                        <div className="text-gray-400 text-sm mb-2">
                          {mode === 'spend' ? 'é€™æœƒè®“ä½ çš„é€€ä¼‘å»¶å¾Œ' : 'é€™æœƒè®“ä½ çš„é€€ä¼‘ææ—©'}
                        </div>
                        <div className="flex items-baseline justify-center gap-2 mb-2">
                          <span className={`text-5xl font-black ${mode === 'spend' ? 'text-orange-400' : 'text-emerald-400'}`}>
                            {timeFormatted.value}
                          </span>
                          <span className="text-2xl text-gray-400">{timeFormatted.unit}</span>
                        </div>
                        <div className="text-gray-500 text-sm mt-2">
                          ğŸ’¡ ç›¸ç•¶æ–¼ã€Œ{getEquivalent(timeCost, mode === 'spend')}ã€
                        </div>
                        
                        {isRecurring && (
                          <div className={`mt-4 ${mode === 'spend' ? 'bg-orange-500/10 border-orange-500/20' : 'bg-emerald-500/10 border-emerald-500/20'} rounded-xl p-3 border`}>
                            <div className={`text-sm ${mode === 'spend' ? 'text-orange-400' : 'text-emerald-400'}`}>
                              {mode === 'spend' ? 'âš ï¸ æ¯æœˆè¨‚é–±çš„å¨åŠ›é©šäºº' : 'âœ¨ å®šæœŸå„²è“„çš„è¤‡åˆ©å¨åŠ›'}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Submit Button */}
                  <button onClick={handleSubmit} disabled={amount <= 0 || isSaving}
                    className={`w-full py-4 rounded-2xl font-bold text-lg transition-all duration-300 active:scale-95 disabled:opacity-50 ${
                      mode === 'spend' ? 'bg-orange-500 hover:bg-orange-400 text-gray-900' : 'bg-emerald-500 hover:bg-emerald-400 text-gray-900'
                    }`}>{isSaving ? 'è¨˜éŒ„ä¸­...' : mode === 'spend' ? 'è¨˜éŒ„èŠ±è²»' : 'è¨˜éŒ„å„²è“„'}</button>
                </>
              ) : (
                <div className="bg-gray-800/60 backdrop-blur-sm rounded-3xl p-8 text-center animate-slide-up">
                  {resultType === 'spend' ? (
                    <>
                      <div className="text-5xl mb-4">ğŸ˜…</div>
                      <div className="text-2xl text-orange-400 font-bold mb-2">å·²è¨˜éŒ„</div>
                      <div className="text-gray-300 mb-4">
                        é€™ç­†èŠ±è²»è®“é€€ä¼‘å»¶å¾Œäº†<br />
                        <span className="text-orange-400 font-bold text-xl">{timeFormatted.value} {timeFormatted.unit}</span>
                      </div>
                      <div className="text-gray-500 text-sm">æ²’é—œä¿‚ï¼ŒçŸ¥é“ä»£åƒ¹å°±å¥½ï¼Œç¹¼çºŒåŠ æ²¹ï¼</div>
                    </>
                  ) : (
                    <>
                      <div className="text-5xl mb-4">ğŸ‰</div>
                      <div className="text-2xl text-emerald-400 font-bold mb-2">å¤ªæ£’äº†ï¼</div>
                      <div className="text-gray-300 mb-4">
                        ä½ å‰›å‰›ç‚ºè‡ªå·±è´å›äº†<br />
                        <span className="text-emerald-400 font-bold text-xl">{timeFormatted.value} {timeFormatted.unit}</span>
                        çš„è‡ªç”±ï¼
                      </div>
                      <div className="text-gray-500 text-sm italic">{getMotivationalQuote()}</div>
                    </>
                  )}
                </div>
              )}
            </div>
          </div>

          {/* Bottom Nav */}
          <div className="fixed bottom-0 left-0 right-0 bg-gray-900/95 backdrop-blur border-t border-gray-800">
            <div className="max-w-lg mx-auto flex justify-around py-3">
              <button className="flex flex-col items-center text-emerald-400">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span className="text-xs mt-1 font-medium">è¨˜éŒ„</span>
              </button>
              <button onClick={onOpenHistory} className="flex flex-col items-center text-gray-500 hover:text-gray-300">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span className="text-xs mt-1">æ­·å²</span>
              </button>
              <button onClick={onOpenSettings} className="flex flex-col items-center text-gray-500 hover:text-gray-300">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span className="text-xs mt-1">è¨­å®š</span>
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ==================== HISTORY PAGE ====================
    const HistoryPage = ({ records, userData, onClose }) => {
      const { age, retireAge, salary, inflationRate = DEFAULT_INFLATION_RATE, roiRate = DEFAULT_ROI_RATE } = userData;

      const totalSaved = records.filter(r => r.type === 'save').reduce((s, r) => s + r.amount, 0);
      const totalSpent = records.filter(r => r.type === 'spend').reduce((s, r) => s + r.amount, 0);
      const netSavingsImpact = totalSaved - totalSpent;

      const estimatedAge = FinanceCalc.estimatedRetireAge(userData, netSavingsImpact);
      const ageDiff = retireAge - estimatedAge;
      const isAhead = ageDiff > 0.001;
      const isBehind = ageDiff < -0.001;
      const isOnTrack = !isAhead && !isBehind;

      // æ ¼å¼åŒ–å·®ç•°é¡¯ç¤º
      const formatAgeDiff = (diff) => {
        const absDiff = Math.abs(diff);
        const absDays = Math.round(absDiff * 365);
        if (absDays < 1) return { value: '0', unit: 'å¤©' };
        if (absDays < 30) return { value: absDays.toString(), unit: 'å¤©' };
        if (absDays < 365) return { value: Math.round(absDays / 30).toString(), unit: 'å€‹æœˆ' };
        return { value: absDiff.toFixed(1), unit: 'å¹´' };
      };
      const diffDisplay = formatAgeDiff(ageDiff);

      const sortedRecords = [...records].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      const groupedRecords = sortedRecords.reduce((groups, record) => {
        const date = new Date(record.timestamp);
        const key = `${date.getFullYear()}-${date.getMonth() + 1}`;
        if (!groups[key]) groups[key] = [];
        groups[key].push(record);
        return groups;
      }, {});

      return (
        <div className="min-h-screen bg-gradient-to-b from-gray-900 via-gray-900 to-gray-800 pb-8">
          <div className="sticky top-0 bg-gray-900/95 backdrop-blur border-b border-gray-800 z-10">
            <div className="max-w-lg mx-auto px-4 py-4 flex items-center">
              <button onClick={onClose} className="text-gray-400 hover:text-white mr-4 p-1">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
              </button>
              <h1 className="text-xl font-bold text-white">æ­·å²ç´€éŒ„</h1>
            </div>
          </div>

          <div className="max-w-lg mx-auto px-4 pt-4">
            {/* GPS Summary */}
            <div className="bg-gradient-to-br from-gray-800/80 to-gray-800/40 rounded-3xl p-6 mb-6 border border-gray-700/50">
              <div className="grid grid-cols-2 gap-6 mb-6">
                <div className="text-center">
                  <div className="text-3xl font-black text-emerald-400">{formatCurrency(totalSaved)}</div>
                  <div className="text-gray-500 text-sm">ç´¯ç©å„²è“„</div>
                </div>
                <div className="text-center">
                  <div className="text-3xl font-black text-orange-400">{formatCurrency(totalSpent)}</div>
                  <div className="text-gray-500 text-sm">ç´¯ç©èŠ±è²»</div>
                </div>
              </div>
              
              <div className="h-px bg-gray-700 mb-6" />
              
              {/* GPS Timeline */}
              <div className="text-center mb-4">
                <div className="text-gray-400 text-sm mb-3">é€€ä¼‘ GPS</div>
                <div className="flex items-center justify-between">
                  <div>
                    <div className="text-gray-500 text-xs">ğŸ¯ ç›®æ¨™</div>
                    <div className="text-white font-bold text-lg">{retireAge} æ­²</div>
                  </div>
                  <div className="flex-1 mx-4">
                    <div className="h-3 bg-gray-700 rounded-full overflow-hidden relative">
                      <div className={`h-full rounded-full transition-all ${
                        isOnTrack ? 'bg-gray-500' : isAhead ? 'bg-emerald-500' : 'bg-orange-500'
                      }`}
                        style={{ width: `${Math.min(100, Math.max(10, 50 + ageDiff * 10))}%` }} />
                      <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-white rounded-full" />
                    </div>
                  </div>
                  <div>
                    <div className={`text-xs ${isOnTrack ? 'text-gray-400' : isAhead ? 'text-emerald-400' : 'text-orange-400'}`}>
                      ğŸ“ é ä¼°
                    </div>
                    <div className={`font-bold text-lg ${isOnTrack ? 'text-white' : isAhead ? 'text-emerald-400' : 'text-orange-400'}`}>
                      {estimatedAge.toFixed(1)} æ­²
                    </div>
                  </div>
                </div>
              </div>
              
              <div className={`text-center text-sm px-4 py-2 rounded-xl ${
                isOnTrack ? 'bg-gray-700 text-gray-300' :
                isAhead ? 'bg-emerald-500/20 text-emerald-400' : 'bg-orange-500/20 text-orange-400'
              }`}>
                {isOnTrack
                  ? `âœ… å®Œç¾ï¼ç›®å‰å‰›å¥½ç¬¦åˆè¨ˆç•«`
                  : isAhead 
                    ? `ğŸ‰ æ¯”ç›®æ¨™ææ—© ${diffDisplay.value} ${diffDisplay.unit}ï¼`
                    : `ğŸ“ˆ éœ€è¦å†åŠªåŠ› ${diffDisplay.value} ${diffDisplay.unit}`
                }
              </div>
            </div>

            {/* Records List */}
            {Object.keys(groupedRecords).length === 0 ? (
              <div className="text-center py-16">
                <div className="text-5xl mb-4">ğŸ“</div>
                <div className="text-gray-400">é‚„æ²’æœ‰ä»»ä½•ç´€éŒ„</div>
                <div className="text-gray-600 text-sm mt-1">é–‹å§‹è¨˜éŒ„ä½ çš„ç¬¬ä¸€ç­†å§ï¼</div>
              </div>
            ) : (
              Object.entries(groupedRecords).map(([monthKey, monthRecords]) => {
                const [year, month] = monthKey.split('-');
                const monthSaved = monthRecords.filter(r => r.type === 'save').reduce((s, r) => s + r.amount, 0);
                const monthSpent = monthRecords.filter(r => r.type === 'spend').reduce((s, r) => s + r.amount, 0);
                
                return (
                  <div key={monthKey} className="mb-6">
                    <div className="flex justify-between items-center mb-3 px-1">
                      <div className="text-gray-400 font-medium">{year}å¹´{month}æœˆ</div>
                      <div className="flex gap-3 text-sm">
                        <span className="text-emerald-400">+{formatCurrency(monthSaved)}</span>
                        <span className="text-orange-400">-{formatCurrency(monthSpent)}</span>
                      </div>
                    </div>
                    <div className="bg-gray-800/40 rounded-2xl overflow-hidden">
                      {monthRecords.map((record, i) => {
                        const time = formatTime(record.timeCost);
                        const date = new Date(record.timestamp);
                        return (
                          <div key={record.id} className={`flex items-center gap-3 p-4 ${i > 0 ? 'border-t border-gray-700/50' : ''}`}>
                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-lg ${
                              record.type === 'save' ? 'bg-emerald-500/20' : 'bg-orange-500/20'
                            }`}>{record.type === 'save' ? 'ğŸ’°' : 'ğŸ’¸'}</div>
                            <div className="flex-1 min-w-0">
                              <div className="flex justify-between items-start">
                                <div className="min-w-0">
                                  <div className="text-white font-medium truncate">
                                    {record.note || record.category || (record.type === 'save' ? 'å„²è“„' : 'æ¶ˆè²»')}
                                  </div>
                                  <div className="text-gray-500 text-xs">
                                    {record.isRecurring ? 'ğŸ”„ ' : ''}{date.getMonth() + 1}/{date.getDate()}
                                  </div>
                                </div>
                                <div className="text-right ml-2">
                                  <div className={`font-bold ${record.type === 'save' ? 'text-emerald-400' : 'text-orange-400'}`}>
                                    {record.type === 'save' ? '+' : '-'}{formatCurrency(record.amount)}
                                  </div>
                                  <div className={`text-xs ${record.type === 'save' ? 'text-emerald-500/70' : 'text-orange-500/70'}`}>
                                    {record.type === 'save' ? '+' : '-'}{time.value}{time.unit}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </div>
      );
    };

    // ==================== SETTINGS PAGE ====================
    const SettingsPage = ({ userData, onUpdateUser, onClose, onReset }) => {
      const [age, setAge] = useState(userData.age);
      const [salary, setSalary] = useState(userData.salary);
      const [retireAge, setRetireAge] = useState(userData.retireAge);
      const [currentSavings, setCurrentSavings] = useState(userData.currentSavings || 0);
      const [monthlySavings, setMonthlySavings] = useState(userData.monthlySavings || Math.round(userData.salary * 0.2));
      const [inflationRate, setInflationRate] = useState(userData.inflationRate || DEFAULT_INFLATION_RATE);
      const [roiRate, setRoiRate] = useState(userData.roiRate || DEFAULT_ROI_RATE);
      const [showConfirm, setShowConfirm] = useState(false);
      const [isClearing, setIsClearing] = useState(false);
      const [calculatorMode, setCalculatorMode] = useState('age'); // age, fund, lifestyle
      const [targetFund, setTargetFund] = useState(30000000);
      const [monthlyRetirement, setMonthlyRetirement] = useState(50000);

      const handleSave = () => {
        onUpdateUser({ age, salary, retireAge, currentSavings, monthlySavings, inflationRate, roiRate,
          targetRetirementFund: Math.round(FinanceCalc.targetFundByAge(currentSavings, monthlySavings, retireAge - age, realRate))
        });
        onClose();
      };

      const handleClear = async () => {
        setIsClearing(true);
        await onReset();
        setIsClearing(false);
      };

      const hourlyRate = Math.round(salary / WORKING_DAYS_PER_MONTH / WORKING_HOURS_PER_DAY);
      const realRate = FinanceCalc.realRate(inflationRate, roiRate);
      const yearsToRetire = retireAge - age;

      // Calculator results
      const calcResults = useMemo(() => {
        if (calculatorMode === 'age') {
          const fund = FinanceCalc.targetFundByAge(currentSavings, monthlySavings, yearsToRetire, realRate);
          const monthly = FinanceCalc.fundToMonthly(fund);
          return { fund, monthly };
        } else if (calculatorMode === 'fund') {
          const years = FinanceCalc.yearsToTarget(currentSavings, monthlySavings, targetFund, realRate);
          return { years, retireAge: age + years };
        } else {
          const requiredFund = FinanceCalc.monthlyToFund(monthlyRetirement);
          const years = FinanceCalc.yearsToTarget(currentSavings, monthlySavings, requiredFund, realRate);
          const requiredSavings = FinanceCalc.requiredMonthlySavings(currentSavings, requiredFund, yearsToRetire, realRate);
          return { requiredFund, years, retireAge: age + years, requiredSavings };
        }
      }, [calculatorMode, currentSavings, monthlySavings, yearsToRetire, realRate, age, targetFund, monthlyRetirement]);

      return (
        <div className="min-h-screen bg-gradient-to-b from-gray-900 via-gray-900 to-gray-800 pb-8">
          <div className="sticky top-0 bg-gray-900/95 backdrop-blur border-b border-gray-800 z-10">
            <div className="max-w-lg mx-auto px-4 py-4 flex items-center justify-between">
              <div className="flex items-center">
                <button onClick={onClose} className="text-gray-400 hover:text-white mr-4 p-1">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                </button>
                <h1 className="text-xl font-bold text-white">è¨­å®š</h1>
              </div>
              <button onClick={handleSave}
                className="bg-emerald-500 hover:bg-emerald-400 text-gray-900 font-bold py-2 px-4 rounded-xl text-sm">
                å„²å­˜
              </button>
            </div>
          </div>

          <div className="max-w-lg mx-auto px-4 pt-6">
            {/* User Settings */}
            <div className="bg-gray-800/50 rounded-3xl p-6 mb-6">
              <h2 className="text-white font-bold mb-6">å€‹äººè³‡æ–™</h2>
              <div className="space-y-6">
                <div>
                  <div className="flex justify-between mb-2">
                    <span className="text-gray-400">å¹´é½¡</span>
                    <span className="text-white font-bold">{age} æ­²</span>
                  </div>
                  <input type="range" min="18" max="60" value={age}
                    onChange={(e) => setAge(parseInt(e.target.value))} className="slider w-full" />
                </div>
                <div>
                  <div className="flex justify-between mb-2">
                    <span className="text-gray-400">æœˆè–ª</span>
                    <span className="text-white font-bold">{formatCurrencyFull(salary)}</span>
                  </div>
                  <input type="range" min="25000" max="500000" step="5000" value={salary}
                    onChange={(e) => setSalary(parseInt(e.target.value))} className="slider w-full" />
                  <div className="text-gray-500 text-sm mt-1">æ™‚è–ªç´„ ${hourlyRate}</div>
                </div>
                <div>
                  <div className="flex justify-between mb-2">
                    <span className="text-gray-400">ğŸ¯ ç›®æ¨™é€€ä¼‘å¹´é½¡</span>
                    <span className="text-white font-bold">{retireAge} æ­²</span>
                  </div>
                  <input type="range" min={age + 5} max="75" value={retireAge}
                    onChange={(e) => setRetireAge(parseInt(e.target.value))} className="slider w-full" />
                  <div className="text-emerald-400 text-sm mt-1">é‚„æœ‰ {yearsToRetire} å¹´</div>
                </div>
                <div>
                  <div className="flex justify-between mb-2">
                    <span className="text-gray-400">ç›®å‰å­˜æ¬¾</span>
                    <span className="text-white font-bold">{formatCurrencyFull(currentSavings)}</span>
                  </div>
                  <input type="range" min="0" max="20000000" step="100000" value={currentSavings}
                    onChange={(e) => setCurrentSavings(parseInt(e.target.value))} className="slider w-full" />
                </div>
                <div>
                  <div className="flex justify-between mb-2">
                    <span className="text-gray-400">æ¯æœˆå„²è“„</span>
                    <span className="text-white font-bold">{formatCurrencyFull(monthlySavings)}</span>
                  </div>
                  <input type="range" min="0" max={Math.min(salary, 200000)} step="1000" value={monthlySavings}
                    onChange={(e) => setMonthlySavings(parseInt(e.target.value))} className="slider w-full" />
                  <div className="text-gray-500 text-sm mt-1">ä½”æœˆè–ª {Math.round(monthlySavings / salary * 100)}%</div>
                </div>
              </div>
            </div>

            {/* Retirement Calculator */}
            <div className="bg-gray-800/50 rounded-3xl p-6 mb-6">
              <h2 className="text-white font-bold mb-2">ğŸ§® é€€ä¼‘è¨ˆç®—æ©Ÿ</h2>
              <p className="text-gray-500 text-xs mb-4">æ›å€‹è§’åº¦çœ‹ä½ çš„é€€ä¼‘è¨ˆç•«</p>
              
              {/* Mode Tabs */}
              <div className="flex gap-2 mb-6 overflow-x-auto hide-scrollbar">
                {[
                  { id: 'age', label: 'å¹´é½¡å°å‘' },
                  { id: 'fund', label: 'é‡‘é¡å°å‘' },
                  { id: 'lifestyle', label: 'ç”Ÿæ´»å“è³ª' },
                ].map(m => (
                  <button key={m.id} onClick={() => setCalculatorMode(m.id)}
                    className={`px-3 py-2 rounded-lg text-sm whitespace-nowrap transition-all ${
                      calculatorMode === m.id ? 'bg-emerald-500 text-gray-900 font-semibold' : 'bg-gray-700 text-gray-400'
                    }`}>{m.label}</button>
                ))}
              </div>

              {/* Calculator Content */}
              {calculatorMode === 'age' && (
                <div className="space-y-4">
                  <div className="text-gray-400 text-sm">
                    æŒ‰ç›®å‰è¨­å®šï¼Œ{retireAge} æ­²é€€ä¼‘æ™‚...
                  </div>
                  <div className="bg-emerald-500/10 rounded-xl p-4 border border-emerald-500/20">
                    <div className="text-emerald-400 text-sm mb-1">å¯ç´¯ç©é€€ä¼‘é‡‘</div>
                    <div className="text-emerald-400 text-2xl font-bold">{formatCurrency(Math.round(calcResults.fund))}</div>
                    <div className="text-emerald-400/70 text-xs mt-2">
                      é€€ä¼‘å¾Œæ¯æœˆå¯é ˜ç´„ {formatCurrency(Math.round(calcResults.monthly))}ï¼ˆ4%æ³•å‰‡ï¼‰
                    </div>
                  </div>
                </div>
              )}

              {calculatorMode === 'fund' && (
                <div className="space-y-4">
                  <div>
                    <div className="flex justify-between mb-2">
                      <span className="text-gray-400">ç›®æ¨™é€€ä¼‘é‡‘</span>
                      <span className="text-white font-bold">{formatCurrency(targetFund)}</span>
                    </div>
                    <input type="range" min="5000000" max="100000000" step="1000000" value={targetFund}
                      onChange={(e) => setTargetFund(parseInt(e.target.value))} className="slider w-full" />
                  </div>
                  <div className="bg-blue-500/10 rounded-xl p-4 border border-blue-500/20">
                    <div className="text-blue-400 text-sm mb-1">é è¨ˆé”æˆå¹´é½¡</div>
                    <div className="text-blue-400 text-2xl font-bold">{calcResults.retireAge.toFixed(1)} æ­²</div>
                    <div className="text-blue-400/70 text-xs mt-2">
                      é‚„éœ€è¦ {calcResults.years.toFixed(1)} å¹´
                    </div>
                  </div>
                </div>
              )}

              {calculatorMode === 'lifestyle' && (
                <div className="space-y-4">
                  <div>
                    <div className="flex justify-between mb-2">
                      <span className="text-gray-400">é€€ä¼‘å¾Œæ¯æœˆæƒ³é ˜</span>
                      <span className="text-white font-bold">{formatCurrencyFull(monthlyRetirement)}</span>
                    </div>
                    <input type="range" min="20000" max="200000" step="5000" value={monthlyRetirement}
                      onChange={(e) => setMonthlyRetirement(parseInt(e.target.value))} className="slider w-full" />
                  </div>
                  <div className="bg-purple-500/10 rounded-xl p-4 border border-purple-500/20">
                    <div className="text-purple-400 text-sm mb-1">éœ€è¦ç´¯ç©</div>
                    <div className="text-purple-400 text-2xl font-bold">{formatCurrency(calcResults.requiredFund)}</div>
                    <div className="text-purple-400/70 text-xs mt-2">
                      æŒ‰ç›®å‰é€²åº¦éœ€ {calcResults.years.toFixed(1)} å¹´ï¼ˆ{calcResults.retireAge.toFixed(0)}æ­²ï¼‰
                    </div>
                    {yearsToRetire > 0 && (
                      <div className="text-purple-400/70 text-xs mt-1">
                        è‹¥è¦ {retireAge} æ­²é”æˆï¼Œæ¯æœˆéœ€å­˜ {formatCurrency(Math.round(Math.max(0, calcResults.requiredSavings)))}
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>

            {/* Financial Parameters */}
            <div className="bg-gray-800/50 rounded-3xl p-6 mb-6">
              <h2 className="text-white font-bold mb-2">è¨ˆç®—åƒæ•¸</h2>
              <p className="text-gray-500 text-xs mb-6">å¯ä¾å€‹äººé æœŸèª¿æ•´</p>
              <div className="space-y-6">
                <div>
                  <div className="flex justify-between mb-2">
                    <span className="text-gray-400">é€šè†¨ç‡</span>
                    <span className="text-white font-bold">{inflationRate}%</span>
                  </div>
                  <input type="range" min="0" max="10" step="0.5" value={inflationRate}
                    onChange={(e) => setInflationRate(parseFloat(e.target.value))} className="slider w-full" />
                </div>
                <div>
                  <div className="flex justify-between mb-2">
                    <span className="text-gray-400">æŠ•è³‡å ±é…¬ç‡</span>
                    <span className="text-white font-bold">{roiRate}%</span>
                  </div>
                  <input type="range" min="0" max="15" step="0.5" value={roiRate}
                    onChange={(e) => setRoiRate(parseFloat(e.target.value))} className="slider w-full" />
                </div>
                <div className="bg-emerald-500/10 rounded-xl p-4 border border-emerald-500/20">
                  <div className="flex justify-between">
                    <span className="text-emerald-400">å¯¦è³ªå ±é…¬ç‡</span>
                    <span className="text-emerald-400 font-bold">â‰ˆ {(realRate * 100).toFixed(2)}%</span>
                  </div>
                </div>
              </div>
            </div>

            {/* Cloud Status */}
            <div className="bg-gray-800/50 rounded-3xl p-6 mb-6">
              <h2 className="text-white font-bold mb-4">è³‡æ–™åŒæ­¥</h2>
              <div className="flex items-center gap-3">
                <div className={`w-3 h-3 rounded-full ${GAS_WEB_APP_URL ? 'bg-emerald-400' : 'bg-gray-500'}`} />
                <span className="text-gray-300">
                  {GAS_WEB_APP_URL ? 'Google Sheets å·²é€£æ¥' : 'Google Sheets æœªè¨­å®š'}
                </span>
              </div>
            </div>

            {/* Danger Zone */}
            <div className="bg-red-900/20 rounded-3xl p-6 border border-red-900/30">
              <h2 className="text-red-400 font-bold mb-4">å±éšªå€åŸŸ</h2>
              {!showConfirm ? (
                <button onClick={() => setShowConfirm(true)} className="text-red-400 text-sm hover:text-red-300">
                  æ¸…é™¤æ‰€æœ‰è³‡æ–™
                </button>
              ) : (
                <div>
                  <p className="text-gray-400 text-sm mb-3">ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ</p>
                  <div className="flex gap-3">
                    <button onClick={handleClear} disabled={isClearing}
                      className="bg-red-500 text-white px-4 py-2 rounded-xl text-sm font-medium disabled:opacity-50">
                      {isClearing ? 'æ¸…é™¤ä¸­...' : 'ç¢ºå®šæ¸…é™¤'}
                    </button>
                    <button onClick={() => setShowConfirm(false)}
                      className="bg-gray-700 text-gray-300 px-4 py-2 rounded-xl text-sm">å–æ¶ˆ</button>
                  </div>
                </div>
              )}
            </div>

            <div className="text-center text-gray-600 text-sm mt-8">TimeBar v2.2.1</div>
          </div>
        </div>
      );
    };

    // ==================== MAIN APP ====================
    function App() {
      const [screen, setScreen] = useState('loading');
      const [userData, setUserData] = useState(null);
      const [records, setRecords] = useState([]);

      useEffect(() => {
        const timer = setTimeout(() => {
          const saved = Storage.load('userData');
          const savedRecords = Storage.load('records', []);
          
          if (saved) {
            setUserData({
              ...saved,
              inflationRate: saved.inflationRate ?? DEFAULT_INFLATION_RATE,
              roiRate: saved.roiRate ?? DEFAULT_ROI_RATE,
              monthlySavings: saved.monthlySavings ?? Math.round(saved.salary * 0.2),
            });
            setRecords(savedRecords);
            setScreen('main');
          } else {
            setScreen('onboarding');
          }
        }, 800);
        return () => clearTimeout(timer);
      }, []);

      useEffect(() => {
        if (userData) {
          Storage.save('userData', userData);
          GoogleSheetsAPI.saveUserData(userData);
        }
      }, [userData]);

      useEffect(() => {
        if (records.length > 0) Storage.save('records', records);
      }, [records]);

      const handleOnboardingComplete = (data) => { setUserData(data); setScreen('main'); };
      const handleAddRecord = async (record) => { setRecords(prev => [...prev, record]); await GoogleSheetsAPI.saveRecord(record); };
      const handleUpdateUser = (data) => { setUserData(data); };
      const handleReset = async () => {
        await GoogleSheetsAPI.clearAllData();
        Storage.clear();
        setUserData(null);
        setRecords([]);
        setScreen('onboarding');
      };

      if (screen === 'loading') {
        return (
          <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center">
            <div className="text-4xl font-black text-white mb-4">Time<span className="text-emerald-400">Bar</span></div>
            <div className="spinner" />
          </div>
        );
      }

      return (
        <div>
          {screen === 'onboarding' && <OnboardingScreen onComplete={handleOnboardingComplete} />}
          {screen === 'main' && userData && (
            <MainTracker userData={userData} records={records} onAddRecord={handleAddRecord}
              onOpenHistory={() => setScreen('history')} onOpenSettings={() => setScreen('settings')} />
          )}
          {screen === 'history' && userData && (
            <HistoryPage records={records} userData={userData} onClose={() => setScreen('main')} />
          )}
          {screen === 'settings' && userData && (
            <SettingsPage userData={userData} onUpdateUser={handleUpdateUser}
              onClose={() => setScreen('main')} onReset={handleReset} />
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
